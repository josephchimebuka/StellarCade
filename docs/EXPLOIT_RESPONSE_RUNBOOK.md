# Stellarcade Exploit Response Runbook

> **Audience:** On-call engineers, security team, and contract admins.  
> **Scope:** Covers all contracts in the Stellarcade platform with emphasis on `exploit-prevention`.

---

## Severity Classification

| Severity | Definition | Response Time |
|---|---|---|
| **P0 – Critical** | Funds at risk, active drain, replay in progress | Immediate (< 15 min) |
| **P1 – High** | Exploit confirmed, no active drain yet | < 1 hour |
| **P2 – Medium** | Anomaly detected, unconfirmed exploit | < 4 hours |
| **P3 – Low** | Theoretical vulnerability, no active risk | < 24 hours |

---

## Step 1 — Detection

Exploits are typically detected via one of:

- **Event indexer alerts**: Watch for bursts of `("exploit", "rply_blk")`, `("exploit", "stl_rej")`, or `("exploit", "rng_rej")` events.
- **On-chain monitoring**: Unusual prize-pool outflows, repeated identical game IDs, rapid successive calls from a single address.
- **Community report**: Discord/Twitter report of suspicious winnings.
- **Automated invariant check**: Off-chain service verifying `pool_balance >= sum(pending_payouts)`.

**Triage checklist:**
- [ ] Identify the source address(es) involved.
- [ ] Identify the contract(s) affected.
- [ ] Determine whether funds have left the prize pool.
- [ ] Estimate the total exposure.

---

## Step 2 — Immediate Containment (P0/P1)

### 2a. Pause the exploit-prevention contract

```bash
# Using Stellar CLI with the admin key
stellar contract invoke \
  --id <EXPLOIT_PREVENTION_CONTRACT_ID> \
  --source <ADMIN_KEYPAIR> \
  --network mainnet \
  -- pause \
  --caller <ADMIN_ADDRESS>
```

This immediately blocks all operations guarded by this contract across the platform.

### 2b. Pause dependent contracts (if not gated through exploit-prevention)

```bash
stellar contract invoke \
  --id <PRIZE_POOL_CONTRACT_ID> \
  --source <ADMIN_KEYPAIR> \
  --network mainnet \
  -- pause \
  --caller <ADMIN_ADDRESS>
```

### 2c. Blacklist offending address (backend)

Update the Redis deny-list used by the Node.js backend to block the attacker's address from submitting new transactions:

```bash
redis-cli SET "deny:<ATTACKER_ADDRESS>" 1 EX 86400
```

### 2d. Notify stakeholders

- Post in `#incident-response` Discord channel.
- Alert core team via PagerDuty/SMS.
- Draft a preliminary statement for public channels (do NOT reveal exploit details yet).

---

## Step 3 — Investigation

### 3a. Collect evidence

```bash
# Fetch all events for the exploit-prevention contract
stellar events \
  --id <EXPLOIT_PREVENTION_CONTRACT_ID> \
  --network mainnet \
  --start-ledger <SUSPECTED_START_LEDGER>
```

Key events to look for:

| Event | Indicates |
|---|---|
| `"rply_blk"` | Replay attempt was blocked (or succeeded before fix) |
| `"stl_rej"` | Settlement was manipulated |
| `"rng_rej"` | RNG proof was forged |
| `"orc_rej"` | Oracle data was tampered |
| Absence of `"rt_lmt"` despite high call volume | Rate-limit bypass |

### 3b. Replay verification

Check if a specific nonce or TX hash was processed more than once:

```bash
stellar contract invoke \
  --id <EXPLOIT_PREVENTION_CONTRACT_ID> \
  --source <READ_ONLY_KEY> \
  --network mainnet \
  -- is_nonce_consumed \
  --nonce <NONCE_VALUE>
```

### 3c. Accounting audit

Query the prize-pool contract for `pool_balance` and reconcile against the sum of all recorded wagers and payouts in the PostgreSQL database.

```sql
SELECT 
  SUM(wager_amount) AS total_in,
  SUM(payout_amount) AS total_out,
  SUM(wager_amount) - SUM(payout_amount) AS expected_balance
FROM game_rounds
WHERE settled_at > NOW() - INTERVAL '24 hours';
```

Compare `expected_balance` with on-chain `pool_balance`.

---

## Step 4 — Fix & Patch

### Known exploit patterns and mitigations

| Exploit Type | Mitigation | Contract Method |
|---|---|---|
| Replay attack (nonce reuse) | All nonces now persisted for 7 days | `consume_nonce` |
| TX hash replay | TX hashes persisted for 7 days | `consume_tx_hash` |
| RNG manipulation | VRF proof validation | `validate_rng_proof` |
| Oracle price tampering | Signature verification + auth check | `validate_oracle_data` |
| Settlement inflation | Conservation invariant check | `validate_settlement` |
| Griefing / DoS via spam | Per-caller rate limiting | `check_rate_limit` |
| Oversized wager drain | Amount bounds check | `check_amount` |
| Stale-price oracle attack | Timestamp staleness check | `check_timestamp` |

### Deploying a patch

1. Fix the vulnerability in the Rust source.
2. Run the full test suite: `cargo test --package exploit-prevention --features testutils`
3. Build the WASM: `cargo build --release --target wasm32-unknown-unknown --package exploit-prevention`
4. Deploy the updated contract using `stellar contract deploy` (upgrade authority must be admin).
5. Verify the new contract address and update environment configs.

---

## Step 5 — Recovery

### 5a. Verify the fix

Before unpausing, confirm:
- [ ] Patch deployed and verified on testnet.
- [ ] All test paths pass (including the attack vector).
- [ ] On-chain state is consistent (no orphaned nonces, correct balances).

### 5b. Unpause

```bash
stellar contract invoke \
  --id <EXPLOIT_PREVENTION_CONTRACT_ID> \
  --source <ADMIN_KEYPAIR> \
  --network mainnet \
  -- unpause \
  --caller <ADMIN_ADDRESS>
```

### 5c. Refund affected users (if funds were lost)

If the exploit drained funds from legitimate users, initiate a manual refund from the platform reserve treasury multisig. Document each refund on-chain.

---

## Step 6 — Post-Incident

- [ ] Write an internal post-mortem within 48 hours.
- [ ] File a public transparency report (if P0/P1) after fix is live.
- [ ] Update monitoring rules to catch the same pattern earlier.
- [ ] Add a regression test for the exact attack vector.
- [ ] Review all dependent contracts for the same vulnerability class.
- [ ] Consider a third-party audit if the vulnerability was architectural.

---

## Contact & Escalation

| Role | Contact |
|---|---|
| Contract Admin | `admin@stellarcade.io` (internal) |
| Security Team | `security@stellarcade.io` |
| Stellar Foundation | `security@stellar.org` |
| On-call Rotation | PagerDuty service: `stellarcade-oncall` |

---

## References

- [Soroban Contract Security Guide](https://developers.stellar.org/docs/smart-contracts/security)
- [Stellar Developer Discord](https://discord.gg/stellar)
- `contracts/exploit-prevention/README.md` — method reference
- `SECURITY.md` — responsible disclosure policy